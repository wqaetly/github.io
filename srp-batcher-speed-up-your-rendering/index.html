<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>(译)SRP Batcher Speed up your rendering! | 烟雨迷离半世殇的成长之路</title><meta name="keywords" content="图形渲染,URP,文献翻译,Shader,Unity,SRP Batcher"><meta name="author" content="烟雨迷离半世殇"><meta name="copyright" content="烟雨迷离半世殇"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="推荐去个人网站或者原文观阅文章，因为文章中有嵌入式视频： https:&#x2F;&#x2F;www.lfzxb.top&#x2F;srp-batcher-speed-up-your-rendering&#x2F; 本文翻译自：SRP Batcher: Speed up your rendering! 和 https:&#x2F;&#x2F;docs.unity3d.com&#x2F;Manual&#x2F;SRPBatcher.html  在2018，我们介绍了一个被称为">
<meta property="og:type" content="article">
<meta property="og:title" content="(译)SRP Batcher Speed up your rendering!">
<meta property="og:url" content="https://www.lfzxb.top/srp-batcher-speed-up-your-rendering/index.html">
<meta property="og:site_name" content="烟雨迷离半世殇的成长之路">
<meta property="og:description" content="推荐去个人网站或者原文观阅文章，因为文章中有嵌入式视频： https:&#x2F;&#x2F;www.lfzxb.top&#x2F;srp-batcher-speed-up-your-rendering&#x2F; 本文翻译自：SRP Batcher: Speed up your rendering! 和 https:&#x2F;&#x2F;docs.unity3d.com&#x2F;Manual&#x2F;SRPBatcher.html  在2018，我们介绍了一个被称为">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages_2/20210314202427.gif!webp">
<meta property="article:published_time" content="2021-03-14T00:00:00.000Z">
<meta property="article:modified_time" content="2021-03-14T00:00:00.000Z">
<meta property="article:author" content="烟雨迷离半世殇">
<meta property="article:tag" content="图形渲染">
<meta property="article:tag" content="URP">
<meta property="article:tag" content="文献翻译">
<meta property="article:tag" content="Shader">
<meta property="article:tag" content="Unity">
<meta property="article:tag" content="SRP Batcher">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages_2/20210314202427.gif!webp"><link rel="shortcut icon" href="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/2020/05/avatar_0001.png!webp"><link rel="canonical" href="https://www.lfzxb.top/srp-batcher-speed-up-your-rendering/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="AhlEJ91V_L12bkwRF1ZS0BbytGCfsjqCX4GXztUluC8"/><meta name="baidu-site-verification" content="iRRtEBalDiujISsN"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-7235595771604497',
  enable_page_level_ads: 'true'
});</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-03-14 00:00:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = '2'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><link rel="stylesheet" href="/css/CustomIcons/iconfontformaliyun.css"><style>#nav #site-name { display: none;}</style><meta name="generator" content="Hexo 5.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/2020/05/avatar_0001.png!webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">145</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">63</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">37</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-torii-gate"></i><span> 蓬莱仙境</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-stream"></i><span> 白驹过隙</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 包罗万象</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分朋引类</span></a></div><div class="menus_item"><a class="site-page" href="/self/"><i class="fa-fw fas fa-id-card"></i><span> 择交而友</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-dice-d20"></i><span> 壶里乾坤</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 莺声婉转</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 往昔回忆</span></a></li><li><a class="site-page" href="/artitalk/"><i class="fa-fw fas fa-coffee"></i><span> 杯酒言欢</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 一见如故</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages_2/20210314202427.gif!webp)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">烟雨迷离半世殇的成长之路</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 寻幽探胜</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-torii-gate"></i><span> 蓬莱仙境</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-stream"></i><span> 白驹过隙</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 包罗万象</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分朋引类</span></a></div><div class="menus_item"><a class="site-page" href="/self/"><i class="fa-fw fas fa-id-card"></i><span> 择交而友</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-dice-d20"></i><span> 壶里乾坤</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 莺声婉转</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 往昔回忆</span></a></li><li><a class="site-page" href="/artitalk/"><i class="fa-fw fas fa-coffee"></i><span> 杯酒言欢</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 一见如故</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">(译)SRP Batcher Speed up your rendering!</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-03-14T00:00:00.000Z" title="发表于 2021-03-14 00:00:00">2021-03-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-03-14T00:00:00.000Z" title="更新于 2021-03-14 00:00:00">2021-03-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/">游戏引擎</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%9B%BE%E5%BD%A2%E6%B8%B2%E6%9F%93/">图形渲染</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/Unity/">Unity</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%9B%BE%E5%BD%A2%E6%B8%B2%E6%9F%93/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">基础知识</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">3.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>12分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><meta name="referrer" content="no-referrer" />
<p>推荐去个人网站或者原文观阅文章，因为文章中有嵌入式视频：</p>
<p><a href="https://www.lfzxb.top/srp-batcher-speed-up-your-rendering/">https://www.lfzxb.top/srp-batcher-speed-up-your-rendering/</a></p>
<p>本文翻译自：<a target="_blank" rel="noopener" href="https://blogs.unity3d.com/2019/02/28/srp-batcher-speed-up-your-rendering/">SRP Batcher: Speed up your rendering!</a> 和 <a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SRPBatcher.html">https://docs.unity3d.com/Manual/SRPBatcher.html</a></p>
<blockquote>
<p>在2018，我们介绍了一个被称为SRP的高度自定义的渲染技术，一个被称为SRP Batcher新的引擎底层Loop就是这个技术的一部分，SRP Batcher可以在渲染时加速你的CPU 1.2到4倍（这取决于你的场景）。让我们看看如何这个功能的最佳实践吧！</p>
</blockquote>
<iframe width="100%" height="315" src="https://www.youtube.com/embed/pUM7ifjGKkM" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<p>上面那个视频显示了Unity渲染时最坏的一个场景：每个对象都是动态的，并且使用不同的材质（材质的颜色或者贴图等属性不同），所以尽管非常多相同的Mesh，但是在渲染时每个Mesh都会被当成不同的Mesh进行渲染（所以无法使用GPU Instance优化技术）。这个场景使用SRP Batcher在PS4平台上可以加速4倍（这个视频是PC的，渲染API是DX11）</p>
<p><em>注意：当我们谈及4倍的加速时，我们说的是CPU端的渲染相关代码（例如在Profiler中显示的“RenderLoop.Draw”h和“ShadowLoop.Draw”标签），而不是总的渲染帧率。</em></p>
<h2 id="unity和materials"><a class="markdownIt-Anchor" href="#unity和materials"></a> Unity和Materials</h2>
<p>Unity是一个非常灵活的渲染引擎，你可以在一帧的的任何时间点修改任何Material属性。此外，Unity历史版本的渲染管线并不是面向Constant Buffer进行开发的，这是为了支持DX9这样的图形API。但是，这样漂亮的功能有一些弊端，比如当一个DrawCall要求使用一个新的Material的时候，需要有大量的工作去处理，所以，你在一个场景中的Material越多，为了设置GPU端的数据而占用的CPU资源就越多。解决此问题的传统方法是减少DrawCall的数量以优化CPU渲染消耗，因为Unity在发出DrawCall之前必须进行很多设置。而且实际的CPU消耗就来自该设置，而不是来自GPU DrawCall本身，而这只是Unity需要将其推送到GPU命令缓冲区的一些字节而已。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages_2/20210314185722.png!webp" alt="image-20210314185722632" /></p>
<p>在渲染的循环中，当一个新的Material被发现了，CPU会收集所有的属性并且在GPU的内存中设置不同的Constant Buffers。GPU缓冲区的数量就取决于Shader是如何声明其CBUFFERs的。</p>
<p>译者PS：上文提到的Constant Buffer对应于GPU上的一种常量内存缓存，速度仅次于流处理器族中的共享内存和寄存器，下图来自《全局光照技术》（手机拍照不好看，就pdf截图了）</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages_2/20210314191119.png!webp" alt="image-20210314191119196" /></p>
<p><img src= "/img/loading.gif" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages_2/20210314191131.png!webp" alt="image-20210314191131547" /></p>
<h2 id="spr是如何工作的"><a class="markdownIt-Anchor" href="#spr是如何工作的"></a> SPR是如何工作的</h2>
<p>当我们开发SRP的时候，我们不得不重写一些引擎的底层部分。这同样是一个好机会，我们可以原生地集成一些新的规范，例如GPU数据持久化。我们旨在加快场景使用大量不同材质（但Shader变体很少）的这种常见情况。</p>
<p>现在，<strong>底层的渲染Loop可以把material的数据持久化在GPU的内存。如果material的内容没有改变，我们就不需要设置，上传buffer到GPU</strong>。此外，我们使用特定的代码路径来在一个大的GPU buffer中快速的更新引擎的内置属性。现在这个新的流程图就像这样：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages_2/20210314191849.png!webp" alt="image-20210314191849638" /></p>
<p>这样，CPU就只需要处理引擎内置的属性（例如标记为对象的变换的属性）。所有的Materials都在GPU内存上有一块持久化的CBUFFERs。综上所述，SRP Batcher加速来自于两个不同的方面：</p>
<ul>
<li>每个材质的内容持久化在GPU的memory上</li>
<li>一个专用的代码路径来管理一个大的“per object”的GPU CBUFFER</li>
</ul>
<h2 id="如何启用srp-batcher"><a class="markdownIt-Anchor" href="#如何启用srp-batcher"></a> 如何启用SRP Batcher</h2>
<p>你的工程必须使用URP,HDRP或者你的自定义SRP。然后就可以在SRP的Asset Inspector面板上进行激活</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages_2/20210314192555.png!webp" alt="image-20210314192555568" /></p>
<p>如果你想要在运行时使用代码来开关SRP Batcher：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GraphicsSettings.useScriptableRenderPipelineBatching = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h2 id="srp-batcher-兼容性"><a class="markdownIt-Anchor" href="#srp-batcher-兼容性"></a> SRP Batcher 兼容性</h2>
<p>对于一个通过SRP Batcher代码路径渲染的对象，有三个要求</p>
<ol>
<li>对象必须是Mesh或者Skinned Mesh，不能是粒子特效</li>
<li>Shader必须与SRP Batcher兼容，所有的在URP或者HDRP中的Lit和Unlit Shader都满足这个需求（除了这些shader的粒子特效版本）</li>
<li>渲染的对象不使用MaterialPropertyBlocks</li>
</ol>
<p>对于一个与SRP Batcher兼容的Shader来说：</p>
<ol>
<li>必须声明所有引擎内置的属性（例如unity_ObjectToWorld，unity_SHAr等）在一个名称为“UnityPerDraw”的CBUFFER中。</li>
<li>必须声明所有的Material属性在一个名为“UnityPerMaterial”的CBUFFER中</li>
</ol>
<p>可以在一个Shader的Inspector面板查看其是否兼容SRP Batcher</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages_2/20210314193932.png!webp" alt="image-20210314193932708" /></p>
<p>在一个给定的Scene中，一些对象时SRP Batcher兼容的，而另一些不是，这个场景仍然可以正常渲染。兼容SRP Batcher的对象使用SRP Batcher的代码路径，另一些将会使用标准的SRP渲染代码路径</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages_2/20210314194218.png!webp" alt="image-20210314194218239" /></p>
<h2 id="性能监测的艺术"><a class="markdownIt-Anchor" href="#性能监测的艺术"></a> 性能监测的艺术</h2>
<h3 id="srpbatcherprofilercs"><a class="markdownIt-Anchor" href="#srpbatcherprofilercs"></a> SRPBatcherProfiler.cs</h3>
<p>如果你想在特定场景测试SRP Batcher带来的性能提升，可以使用SRPBatcherProfiler.cs这一C#脚本（<a target="_blank" rel="noopener" href="https://github.com/Unity-Technologies/SRPBatcherBenchmark/blob/master/Assets/Scripts/SRPBatcherProfiler.cs">这是链接</a>）。</p>
<p>只需要把这个脚本加入你的场景，当游戏运行时，你就能看到一个UI面板，上面记录了一些有用的信息。你还可以使用F9来开关SRP Batcher</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages_2/20210314194548.png!webp" alt="image-20210314194548062" /></p>
<p>在这里，所有时间均以毫秒（ms）为单位。这些时间测量结果显示了在Unity SRP渲染循环中CPU消耗。</p>
<p><em>注意：计时表示在一帧期间调用的所有“RenderLoop.Draw”和“Shadows.Draw”标记的累计时间（所有线程）。例如“1.31ms SRP Batcher code path”，也许只有0.31ms花费在主线程，1ms的是所有的Graphic JobSystem的消耗。</em></p>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>(SRP batcher ON)</strong> / <strong>(SRP batcher OFF)</strong></td>
<td>表示是否开启SRP Batcher，按F9开关</td>
</tr>
<tr>
<td><strong>CPU Rendering time</strong></td>
<td>表示SRP循环在CPU中花费的总的时间，无论使用哪种多线程模式，例如单线程，client/worker或Graphic Job。在这里，您可以最大程度地看到SRP Batcher的效果。要查看批处理程序的优化，请尝试将其打开和关闭以查看CPU耗时的差异。此示例总计为2.11ms。**（incl RT idle）：**表示SRP在渲染线程空闲状态耗时。这可能意味着该应用程序处于client/worker模式，没有任何图形工作，这是在渲染线程必须等待主线程上的渲染命令时发生的。在此示例中，渲染线程空闲了0.36毫秒。</td>
</tr>
<tr>
<td><strong>SRP Batcher code path (flushes)</strong></td>
<td>表示您的游戏或应用程序花费在SRP Batcher代码路径中的时间。这可分为游戏渲染<strong>所有对象</strong>（shadow passes除外）所花费的时间（1.18ms），以及<strong>Shadows</strong>（1.13ms）。如果<strong>Shadows</strong>耗时很高，请尝试减少“场景”中的阴影投射灯数量，或者在“Render Pipeline Asset”中选择较低的Shadow Cascades数量。在这个例子中，它是1.31ms。**(flush(s))**数量表示Unity刷新场景的次数，因为它遇到了新的Shader Variant（在此示例中：89）。较少的flush总是更好的，因为这意味着一个渲染帧中的Shader Variants数量较少。</td>
</tr>
<tr>
<td><strong>Standard code path (flushes)</strong></td>
<td>表示Unity花费在渲染与SRP Batcher不兼容的对象（例如粒子）上的时间。在此示例中，SRP Batcher在0.80ms内flush了81个对象：shadow passes为0.09毫秒，所有其他pass为0.71毫秒。</td>
</tr>
<tr>
<td><strong>Global Main Loop: (FPS)</strong></td>
<td>表示全局主循环时间（以毫秒为单位），可以得知<strong>每秒帧数</strong>（FPS）。注意：“FPS”不是线性的，因此，如果您看到FPS增加20，这并不一定意味着您已经优化了场景。要查看SRP Batcher是否优化了场景渲染，请将其切换为“开”和“关”，然后在<strong>CPU Rendering time</strong>下比较数字。</td>
</tr>
</tbody>
</table>
<p>示例：(译者PS：对于flushes数据变动，个人认为是在SRP Batcher关闭的时候，遇到一个不同材质的就会flush一次，而开启SRP Batcher，flushes值就取决于Shader变体了)</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages_2/20210314202427.gif!webp" alt="image2" /></p>
<h2 id="支持的平台"><a class="markdownIt-Anchor" href="#支持的平台"></a> 支持的平台</h2>
<p>SRP几乎支持所有的平台，下面是一张表，包含了最低Unity版本信息</p>
<table>
<thead>
<tr>
<th style="text-align:left"><strong>Platform</strong></th>
<th style="text-align:center"><strong>Minimum Unity version required</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Windows DirectX 11</td>
<td style="text-align:center">2018.2</td>
</tr>
<tr>
<td style="text-align:left"><strong>PlayStation 4</strong></td>
<td style="text-align:center">2018.2</td>
</tr>
<tr>
<td style="text-align:left">Vulkan</td>
<td style="text-align:center">2018.3</td>
</tr>
<tr>
<td style="text-align:left">OSX Metal</td>
<td style="text-align:center">2018.3</td>
</tr>
<tr>
<td style="text-align:left"><strong>iOS</strong>  Metal</td>
<td style="text-align:center">2018.3</td>
</tr>
<tr>
<td style="text-align:left">Nintendo Switch</td>
<td style="text-align:center">2018.3</td>
</tr>
<tr>
<td style="text-align:left"><strong>Xbox One</strong>  DirectX 11</td>
<td style="text-align:center">2019.2</td>
</tr>
<tr>
<td style="text-align:left">OpenGL 4.2 and higher</td>
<td style="text-align:center">2019.1</td>
</tr>
<tr>
<td style="text-align:left">OpenGL ES 3.1 and higher</td>
<td style="text-align:center">2019.1</td>
</tr>
<tr>
<td style="text-align:left">Xbox One DirectX 12</td>
<td style="text-align:center">2019.1</td>
</tr>
<tr>
<td style="text-align:left">Windows DirectX 12</td>
<td style="text-align:center">2019.1</td>
</tr>
</tbody>
</table>
<h2 id="vr那点事"><a class="markdownIt-Anchor" href="#vr那点事"></a> VR那点事</h2>
<p>SRP Batcher支持VR，但仅限于“SinglePassInstanced”模式，开启VR模式并不会增加任何CPU消耗</p>
<h2 id="常见问题"><a class="markdownIt-Anchor" href="#常见问题"></a> 常见问题</h2>
<h3 id="我怎么知道我当前用法是否是srp-batcher的最佳实践呢"><a class="markdownIt-Anchor" href="#我怎么知道我当前用法是否是srp-batcher的最佳实践呢"></a> 我怎么知道我当前用法是否是SRP Batcher的最佳实践呢？</h3>
<p>使用SRPBatcherProfiler.cs，首先检查SRP Batcher是否开启，然后查看“Standard code path”消耗，应该尽可能接近0。当然了，如果你的场景使用了一些skinned meshes或者粒子特效，“Standard code path”会不可避免的有一些消耗。</p>
<h3 id="无论是否开启srp-batchersrpbatcherprofiler耗时显示都差不多是为啥"><a class="markdownIt-Anchor" href="#无论是否开启srp-batchersrpbatcherprofiler耗时显示都差不多是为啥"></a> 无论是否开启SRP Batcher，SRPBatcherProfiler耗时显示都差不多是为啥？</h3>
<p>首先，您应该检查几乎所有渲染耗时都使用了SRP Batcher的代码路径（请参见上文）。如果是这样，数字仍然相似，则查看“flush”数字。当SRP Batcher打开时，“flush”数量应减少很多。根据经验，减少10倍非常好了，减少2倍也可以接受。如果flush计数没有减少很多，则意味着您仍然有很多Shader变体。尝试减少Shader变体的数量。如果您做了很多不同的着色器，请尝试使用更多参数制作一个“Uber”着色器。这样就无需拥有大量不同的Material参数。</p>
<h3 id="当我开启srp-batcher的时候并没有显著变化是为啥"><a class="markdownIt-Anchor" href="#当我开启srp-batcher的时候并没有显著变化是为啥"></a> 当我开启SRP Batcher的时候并没有显著变化是为啥？</h3>
<p>先看下上面的两个问题。如果SRPBatcherProfiler显示“CPU Rendering time”快两倍，并且FPS不变，则CPU渲染部分不是您的瓶颈。这并不意味着您不是CPU bound，而是因为您可能使用了太多的C＃ Gameplay或太多的物理元素。无论如何，如果“CPU Rendering time”快两倍，那还是不错的。您可能已经在顶部视频中注意到，即使以3.5倍的速度进行加速，场景仍然保持60FPS的速度。那是因为我们已将VSYNC打开。SRP Batcher确实在CPU端节省了6.8ms。这些毫秒可以用于其他任务。它还可以节省移动设备的电池寿命。</p>
<h2 id="如何高效的检查srp-batcher"><a class="markdownIt-Anchor" href="#如何高效的检查srp-batcher"></a> 如何高效的检查SRP Batcher</h2>
<p>理解“batcher”在SRP Batcher上下文中含义是很重要的。</p>
<p>传统做法，人们倾向于减少DrawCall的数量以优化CPU渲染消耗。这样做的真正原因是引擎在发出DrawCall之前必须进行很多设置。而且实际的CPU消耗来自该设置，而不是来自GPU DrawCall本身（这只是要放入GPU命令缓冲区的一些字节）。SRP Batcher不会减少DrawCalls的数量。它只是减少了DrawCall之间的GPU设置成本。</p>
<p>您可以在以下工作流程中看到这一点：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages_2/20210314203746.png!webp" alt="image-20210314203746906" /></p>
<p>左侧是标准SRP渲染管线循环。右边是SRP Batcher循环。在SRP Batcher程序上下文中，“batch”只是“Bind”，“Draw”，“Bind”，“Draw”…这样的一个GPU命令的序列。</p>
<p>在标准SRP中，对于每种新material都调用慢的一批的SetShaderPass。在SRP Batcher上下文中，将为每个新的Shader变体调用SetShaderPass。</p>
<p>为了获得最佳性能，您需要将这些batches保持尽可能大。因此，您需要避免任何Shader变体更改，但是如果它们使用相同的Shader，则可以使用任意数量的不同materials。</p>
<p>您可以使用Unity Frame Debugger查看SRP Batcher的“batches”长度。每个批次都是帧调试器中称为“ SRP Batch”的事件，如您在此处看到的：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages_2/20210314205007.png!webp" alt="image-20210314205007279" /></p>
<p>查看左侧的SRP Batch事件。另外查看batch的大小，即Drawcall的数量（此处为109）。这是一个非常有效的batch。您还将看到上一个batch被破坏的原因(“Node use different shader keywords”)。这意味着用于batch的Shader关键字不同于先前batch中的关键字。这意味着shader变体已更改，我们必须中断该batch。</p>
<p>在某些场景中，某些batch大小可能会非常低，例如以下示例：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages_2/20210314205338.png!webp" alt="image-20210314205338410" /></p>
<p>batch大小仅为2。这可能意味着您有太多不同的shader变体。如果要创建自己的SRP，请尝试使用最少的关键字编写通用的“Uber Shader”。您不必担心在“property”部分中输入了多少material参数。</p>
<p><em>注意：Frame Debugger中的SRP Batcher信息需要Unity 2018.3或更高版本。</em></p>
<h2 id="编写你自己的srp-batcher兼容的shader"><a class="markdownIt-Anchor" href="#编写你自己的srp-batcher兼容的shader"></a> 编写你自己的SRP Batcher兼容的Shader</h2>
<p>注意：此部分是专门给高级用户看的，他们会编写他们自己的SRP和Shader库。如果使用我们提供的管线（URP,HDRP）的用户可以跳过，我们提供的Shader是SRP Batcher兼容的。</p>
<p>如果你正在编写自己的渲染循环，你的shader需要遵循以下几条规则来受益于SRP Batcher</p>
<h3 id="per-material变量"><a class="markdownIt-Anchor" href="#per-material变量"></a> “Per Material”变量</h3>
<p>首先，所有的“per material”数据都需要声明在一个名为“UnityPerMaterial”的CBUFFER中。什么是“per material”数据呢？其实就是你定义在“shader property”中所有的变量。这些变量可以显示在material的Inspector面板上。举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Properties</span><br><span class="line">&#123;</span><br><span class="line">	_Color1 (&quot;Color 1&quot;, Color) &#x3D; (1,1,1,1)</span><br><span class="line">	_Color2 (&quot;Color 2&quot;, Color) &#x3D; (1,1,1,1)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float4 _Color1;</span><br><span class="line">float4 _Color2;</span><br></pre></td></tr></table></figure>
<p>如果你编译这个Shader，这个Shader的Inspector面板将会这样显示：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages_2/20210314210139.png" alt="image-20210314210139097" /></p>
<p>为了修复这个问题，仅仅需要这样声明即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CBUFFER_START(UnityPerMaterial)</span><br><span class="line"></span><br><span class="line">float4 _Color1;</span><br><span class="line">float4 _Color2;</span><br><span class="line"></span><br><span class="line">CBUFFER_END</span><br></pre></td></tr></table></figure>
<h3 id="per-object变量"><a class="markdownIt-Anchor" href="#per-object变量"></a> “Per Object”变量</h3>
<p>SRP Batcher同样需要一个名为“UnityPerDraw”的CBUFFER。这个CBUFFER应该包含所有的Unity引擎 built-In的变量</p>
<p>变量声明顺序同 “UnityPerDraw” CBUFFER一样重要。所有变量都应遵循我们称为“Block Feature”的布局。例如，“Space Position block feature”应按以下顺序包含所有这些变量：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CBUFFER_START(UnityPerDraw)</span><br><span class="line">    </span><br><span class="line">float4x4 unity_ObjectToWorld;</span><br><span class="line">float4x4 unity_WorldToObject;</span><br><span class="line">float4 unity_LODFade;</span><br><span class="line">float4 unity_WorldTransformParams;</span><br><span class="line"></span><br><span class="line">CBUFFER_END</span><br></pre></td></tr></table></figure>
<p>如果不需要它们，则不必声明其中的某些block features。“UnityPerDraw”中的所有引擎内置变量应为float4或float4x4。在移动设备上，人们可能想使用real4（16位编码的浮点值）来节省一些GPU带宽。并非所有UnityPerDraw变量都可以使用“real4”。请参考“Could be real4”一栏。</p>
<p>下表描述了可以在“UnityPerDraw” CBUFFER中使用的所有可能的block features：</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages_2/20210314211958.png!webp" alt="Screen-Shot-2019-02-27-at-3.50.52-PM" /></p>
<p>注意：如果将一个feature block的变量之一声明为real4（half），则该feature block的所有其他潜在变量也应声明为real4。</p>
<p>提示1：始终在Inpsector中检查新shader的兼容性状态。我们检查了几个潜在的错误（UnityPerDraw布局声明等），并显示为什么不兼容。</p>
<p>提示2：在编写自己的SRP Shader时，可以参考LWRP或HDRP包以查看其UnityPerDraw CBUFFER声明以获取灵感。</p>
<h2 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h2>
<p><a target="_blank" rel="noopener" href="https://blogs.unity3d.com/2019/02/28/srp-batcher-speed-up-your-rendering/">https://blogs.unity3d.com/2019/02/28/srp-batcher-speed-up-your-rendering/</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Manual/SRPBatcher.html">https://docs.unity3d.com/Manual/SRPBatcher.html</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">烟雨迷离半世殇</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.lfzxb.top/srp-batcher-speed-up-your-rendering/">https://www.lfzxb.top/srp-batcher-speed-up-your-rendering/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.lfzxb.top" target="_blank">烟雨迷离半世殇的成长之路</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%9B%BE%E5%BD%A2%E6%B8%B2%E6%9F%93/">图形渲染</a><a class="post-meta__tags" href="/tags/URP/">URP</a><a class="post-meta__tags" href="/tags/%E6%96%87%E7%8C%AE%E7%BF%BB%E8%AF%91/">文献翻译</a><a class="post-meta__tags" href="/tags/Shader/">Shader</a><a class="post-meta__tags" href="/tags/Unity/">Unity</a><a class="post-meta__tags" href="/tags/SRP-Batcher/">SRP Batcher</a></div><div class="post_share"><div class="social-share" data-image="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages_2/20210314202427.gif!webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/2019/04/QQ截图20190430175314.png!webp" target="_blank"><img class="post-qr-code-img" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/2019/04/QQ截图20190430175314.png!webp" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/2019/04/QQ截图20190430175304.png!webp" target="_blank"><img class="post-qr-code-img" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/2019/04/QQ截图20190430175304.png!webp" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div></div><div class="ads-wrap"><ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-7235595771604497" data-ad-slot="9104433828"></ins><script> (adsbygoogle = window.adsbygoogle || []).push({});</script></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/et6.0-study/"><img class="next-cover" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages_2/20210307151121.png!webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">ET6.0学习笔记</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/air-distortion-based-on-pp-in-urp/" title="URP下基于后处理的热空气扭曲效果"><img class="cover" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages/20210222132832.gif!webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-20</div><div class="title">URP下基于后处理的热空气扭曲效果</div></div></a></div><div><a href="/fog-of-war-based-on-ss-in-urp/" title="URP下基于屏幕空间采样的战争迷雾"><img class="cover" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages/20210204174722.png!webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-07</div><div class="title">URP下基于屏幕空间采样的战争迷雾</div></div></a></div><div><a href="/Introduction-To-Direct3D-12/" title="（译）Introduction To Direct3D 12"><img class="cover" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages/20201230203541.png!webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-04</div><div class="title">（译）Introduction To Direct3D 12</div></div></a></div><div><a href="/fundamentals-of-computer-graphics-chapter11-111-5/" title="纹理映射"><img class="cover" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages/20201023225202.png!webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-09</div><div class="title">纹理映射</div></div></a></div><div><a href="/graphics-base-centre/" title="图形学篇：图形学基础知识汇总（中：多维变换与裁剪投影"><img class="cover" data-lazy-src="https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/2019/06/QQ截图20190615165615.png!webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-01</div><div class="title">图形学篇：图形学基础知识汇总（中：多维变换与裁剪投影</div></div></a></div><div><a href="/graphics-base-up/" title="图形学篇：图形学基础知识汇总（上：基础知识和图形扫描转换及填充）"><img class="cover" data-lazy-src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-01</div><div class="title">图形学篇：图形学基础知识汇总（上：基础知识和图形扫描转换及填充）</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#unity%E5%92%8Cmaterials"><span class="toc-number">1.</span> <span class="toc-text"> Unity和Materials</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#spr%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84"><span class="toc-number">2.</span> <span class="toc-text"> SPR是如何工作的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%90%AF%E7%94%A8srp-batcher"><span class="toc-number">3.</span> <span class="toc-text"> 如何启用SRP Batcher</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#srp-batcher-%E5%85%BC%E5%AE%B9%E6%80%A7"><span class="toc-number">4.</span> <span class="toc-text"> SRP Batcher 兼容性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E7%9B%91%E6%B5%8B%E7%9A%84%E8%89%BA%E6%9C%AF"><span class="toc-number">5.</span> <span class="toc-text"> 性能监测的艺术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#srpbatcherprofilercs"><span class="toc-number">5.1.</span> <span class="toc-text"> SRPBatcherProfiler.cs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%AF%E6%8C%81%E7%9A%84%E5%B9%B3%E5%8F%B0"><span class="toc-number">6.</span> <span class="toc-text"> 支持的平台</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vr%E9%82%A3%E7%82%B9%E4%BA%8B"><span class="toc-number">7.</span> <span class="toc-text"> VR那点事</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="toc-number">8.</span> <span class="toc-text"> 常见问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%91%E6%80%8E%E4%B9%88%E7%9F%A5%E9%81%93%E6%88%91%E5%BD%93%E5%89%8D%E7%94%A8%E6%B3%95%E6%98%AF%E5%90%A6%E6%98%AFsrp-batcher%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%91%A2"><span class="toc-number">8.1.</span> <span class="toc-text"> 我怎么知道我当前用法是否是SRP Batcher的最佳实践呢？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E8%AE%BA%E6%98%AF%E5%90%A6%E5%BC%80%E5%90%AFsrp-batchersrpbatcherprofiler%E8%80%97%E6%97%B6%E6%98%BE%E7%A4%BA%E9%83%BD%E5%B7%AE%E4%B8%8D%E5%A4%9A%E6%98%AF%E4%B8%BA%E5%95%A5"><span class="toc-number">8.2.</span> <span class="toc-text"> 无论是否开启SRP Batcher，SRPBatcherProfiler耗时显示都差不多是为啥？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%93%E6%88%91%E5%BC%80%E5%90%AFsrp-batcher%E7%9A%84%E6%97%B6%E5%80%99%E5%B9%B6%E6%B2%A1%E6%9C%89%E6%98%BE%E8%91%97%E5%8F%98%E5%8C%96%E6%98%AF%E4%B8%BA%E5%95%A5"><span class="toc-number">8.3.</span> <span class="toc-text"> 当我开启SRP Batcher的时候并没有显著变化是为啥？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%AB%98%E6%95%88%E7%9A%84%E6%A3%80%E6%9F%A5srp-batcher"><span class="toc-number">9.</span> <span class="toc-text"> 如何高效的检查SRP Batcher</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E4%BD%A0%E8%87%AA%E5%B7%B1%E7%9A%84srp-batcher%E5%85%BC%E5%AE%B9%E7%9A%84shader"><span class="toc-number">10.</span> <span class="toc-text"> 编写你自己的SRP Batcher兼容的Shader</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#per-material%E5%8F%98%E9%87%8F"><span class="toc-number">10.1.</span> <span class="toc-text"> “Per Material”变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#per-object%E5%8F%98%E9%87%8F"><span class="toc-number">10.2.</span> <span class="toc-text"> “Per Object”变量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">11.</span> <span class="toc-text"> 参考</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2021 By 烟雨迷离半世殇</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">2018-2021 lfzxb.top版权所有</br><a href="https://beian.miit.gov.cn" target="_blank">苏ICP备19003389号-1</a></br><img src = "https://myfirstblog.oss-cn-hangzhou.aliyuncs.com/typoraImages/20210126215735.png!webp" alt = "公网安备字"/><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=32032102000159" target="_blank">苏公网安备 32032102000159号</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">簡</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', '', 'katex-wrap')
  })
})()</script><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    let initData = {
      el: '#twikoo-wrap',
      envId: 'twikoo-4gsr2cmdebe58feb',
      region: ''
    }

    if (false) {
      const otherData = false
      initData = Object.assign(initData, otherData)
    }
    
    twikoo.init(initData)
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'twikoo-4gsr2cmdebe58feb',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script defer data-pjax src="/live2d-widget/autoload.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script>((window.gitter = {}).chat = {}).options = {
  disableDefaultChat: true,
};
document.addEventListener('gitter-sidecar-ready', (e) => {
  const GitterChat = e.detail.Chat
  let chat

  function initGitter () {
    chat = new GitterChat({
      room: 'YYMLBSS/community',
      activationElement: '#chat_btn'
    });
  }

  initGitter()

  if (true) {
    document.addEventListener('pjax:complete', () => {
      chat.destroy()
      initGitter()
    })
  }

})</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async="async" defer="defer"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config_change',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  if (typeof gtag === 'function') {
    gtag('config', '', {'page_path': window.location.pathname});
  }

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})


document.addEventListener('pjax:send', function () {
  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})</script></div></body></html>